# ReqFlow 数据库设计 - 需求拆分功能扩展

## 需求拆分架构设计

基于Epic/Story两层拆分架构，需要添加以下表结构：

## 新增表结构

### 1. Epic表 (epics)

```sql
CREATE TABLE epics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  name VARCHAR(200) NOT NULL,
  description TEXT,
  service_boundary TEXT NOT NULL,
  dependencies JSONB DEFAULT '[]',
  capabilities JSONB DEFAULT '[]',
  domain_models JSONB DEFAULT '[]',
  integration_contracts JSONB DEFAULT '[]',
  priority INTEGER DEFAULT 1,
  status VARCHAR(50) DEFAULT 'not_started',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_epics_project_id ON epics(project_id);
CREATE INDEX idx_epics_status ON epics(status);
CREATE INDEX idx_epics_priority ON epics(priority);
```

**字段说明**：
- `service_boundary`: 业务服务边界描述
- `dependencies`: 依赖的其他Epic服务 (JSON数组)
- `capabilities`: 对外提供的能力 (JSON数组)
- `domain_models`: 领域模型定义 (JSON数组)
- `integration_contracts`: 集成契约 (JSON数组)
- `priority`: 优先级 (1-5，1最高)
- `status`: 状态 ('not_started', 'in_progress', 'completed')

**Epic数据格式示例**：
```json
{
  "name": "用户认证系统",
  "service_boundary": "用户认证、权限管理、会话控制",
  "dependencies": [],
  "capabilities": [
    {
      "endpoint_prefix": "/api/auth/*",
      "description": "认证相关接口"
    },
    {
      "endpoint_prefix": "/api/users/*",
      "description": "用户管理接口"
    }
  ],
  "domain_models": [
    {
      "name": "User",
      "fields": ["id", "email", "role", "status"]
    },
    {
      "name": "Session", 
      "fields": ["token", "user_id", "expires_at"]
    }
  ],
  "integration_contracts": [
    "其他服务获取用户信息必须调用 GET /api/users/{id}",
    "权限验证必须调用 POST /api/auth/verify",
    "禁止直接访问users、sessions数据表"
  ]
}
```

### 2. Story表 (stories)

```sql
CREATE TABLE stories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  epic_id UUID NOT NULL REFERENCES epics(id) ON DELETE CASCADE,
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  title VARCHAR(300) NOT NULL,
  user_story TEXT NOT NULL,
  backend_api JSONB NOT NULL,
  database_design JSONB NOT NULL,
  frontend_specification JSONB NOT NULL,
  acceptance_criteria JSONB NOT NULL,
  mock_contracts JSONB DEFAULT '{}',
  priority INTEGER DEFAULT 1,
  status VARCHAR(50) DEFAULT 'not_started',
  estimated_hours INTEGER,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_stories_epic_id ON stories(epic_id);
CREATE INDEX idx_stories_project_id ON stories(project_id);
CREATE INDEX idx_stories_status ON stories(status);
CREATE INDEX idx_stories_priority ON stories(priority);
```

**字段说明**：
- `user_story`: 用户故事描述
- `backend_api`: 后端API接口定义 (JSON)
- `database_design`: 数据库设计 (JSON)
- `frontend_specification`: 前端UI规格 (JSON)
- `acceptance_criteria`: 验收标准 (JSON)
- `mock_contracts`: Mock数据契约 (JSON)
- `estimated_hours`: 预估工时

**Story数据格式示例**：
```json
{
  "title": "用户邮箱密码登录",
  "user_story": "作为用户，我希望能够通过邮箱和密码登录系统，以便访问个人功能",
  "backend_api": {
    "endpoint": "POST /api/auth/login",
    "request_schema": {
      "email": {"type": "string", "format": "email", "required": true},
      "password": {"type": "string", "minLength": 8, "required": true},
      "remember_me": {"type": "boolean", "default": false}
    },
    "response_schema": {
      "success_200": {
        "access_token": "string",
        "refresh_token": "string", 
        "user": {"id": "string", "email": "string", "role": "string"}
      },
      "error_401": {
        "message": "邮箱或密码错误"
      }
    },
    "business_rules": [
      "密码错误5次锁定账户30分钟",
      "remember_me=true时refresh_token有效期30天"
    ]
  },
  "database_design": {
    "tables": [
      {
        "name": "users",
        "fields": ["id(UUID)", "email(VARCHAR)", "password_hash(VARCHAR)", "status(ENUM)", "last_login_at(TIMESTAMP)"],
        "indexes": ["email(UNIQUE)", "status"]
      },
      {
        "name": "login_attempts",
        "fields": ["id(UUID)", "email(VARCHAR)", "attempts_count(INT)", "locked_until(TIMESTAMP)"],
        "indexes": ["email", "locked_until"]
      }
    ]
  },
  "frontend_specification": {
    "components": [
      {
        "component": "LoginForm",
        "props": [
          {"onSubmit": {"type": "function", "description": "登录提交回调"}},
          {"loading": {"type": "boolean", "default": false}}
        ],
        "layout": "居中卡片布局，最大宽度400px",
        "fields": [
          {"email": {"type": "input", "placeholder": "请输入邮箱", "validation": "实时邮箱格式检查"}},
          {"password": {"type": "password", "placeholder": "请输入密码", "showToggle": true}}
        ],
        "wireframe": "ASCII字符绘制的页面结构图"
      }
    ],
    "routes": [
      {
        "path": "/login",
        "component": "LoginPage",
        "meta": {"title": "用户登录", "requiresGuest": true}
      }
    ],
    "state_management": {
      "store": "authStore",
      "state": [
        {"user": {"type": "object", "default": null}},
        {"isLoggedIn": {"type": "boolean", "default": false}}
      ]
    }
  },
  "acceptance_criteria": {
    "functional": [
      "用户输入正确的邮箱和密码，点击登录按钮，能够成功登录系统",
      "用户输入错误的邮箱或密码，显示'邮箱或密码错误'提示信息"
    ],
    "ui": [
      "登录表单居中显示，最大宽度400px，具有圆角边框和阴影效果",
      "邮箱输入框实时验证邮箱格式，格式错误时显示红色边框"
    ],
    "performance": [
      "登录接口响应时间不超过2秒",
      "页面首次加载时间不超过3秒"
    ],
    "compatibility": [
      "支持Chrome、Firefox、Safari、Edge最新版本",
      "移动端适配iPhone、Android主流设备"
    ],
    "error_handling": [
      "网络异常时显示'网络连接失败，请稍后重试'",
      "服务器错误时显示'系统繁忙，请稍后重试'"
    ],
    "security": [
      "密码在传输和存储时必须加密",
      "登录失败不泄露用户是否存在的信息"
    ]
  },
  "mock_contracts": {
    "POST /api/auth/login": {
      "success_response": {
        "access_token": "mock_jwt_token_xxxxx",
        "refresh_token": "mock_refresh_token_xxxxx",
        "user": {"id": "uuid-1234", "email": "test@example.com", "role": "user"}
      },
      "error_responses": {
        "401": {"message": "邮箱或密码错误"},
        "429": {"message": "请求过于频繁，请稍后再试"}
      }
    }
  }
}
```

### 3. 需求拆分会话表 (requirement_splitting_sessions)

```sql
CREATE TABLE requirement_splitting_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  ai_analysis JSONB,
  epic_suggestions JSONB DEFAULT '[]',
  story_suggestions JSONB DEFAULT '[]',
  user_feedback JSONB DEFAULT '[]',
  is_completed BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_splitting_sessions_project_id ON requirement_splitting_sessions(project_id);
CREATE INDEX idx_splitting_sessions_completed ON requirement_splitting_sessions(is_completed);
```

**字段说明**：
- `ai_analysis`: AI对需求和技术选型的分析结果
- `epic_suggestions`: AI建议的Epic拆分
- `story_suggestions`: AI建议的Story拆分
- `user_feedback`: 用户对AI建议的反馈
- `is_completed`: 拆分会话是否完成

## 更新现有表结构

### 更新项目表状态
```sql
-- 添加新的项目阶段
ALTER TABLE projects 
ALTER COLUMN current_stage TYPE VARCHAR(50);

-- 更新约束，添加新状态
-- 'created' -> 'clarifying' -> 'tech_selecting' -> 'requirement_splitting' -> 'development' -> 'completed'
```

## 数据关系图更新

```
users (1) -----> (N) projects
projects (1) --> (N) ai_conversations
projects (1) --> (N) requirement_splitting_sessions
projects (1) --> (N) epics
epics (1) -----> (N) stories
projects (1) --> (N) stories (冗余关系，便于查询)
```

## 核心查询模式

### 获取项目的Epic和Story结构
```sql
SELECT 
  p.id as project_id,
  p.name as project_name,
  e.id as epic_id,
  e.name as epic_name,
  e.service_boundary,
  json_agg(
    json_build_object(
      'id', s.id,
      'title', s.title,
      'user_story', s.user_story,
      'status', s.status,
      'priority', s.priority
    ) ORDER BY s.priority, s.created_at
  ) as stories
FROM projects p
LEFT JOIN epics e ON p.id = e.project_id
LEFT JOIN stories s ON e.id = s.epic_id
WHERE p.id = $1 AND p.user_id = $2
GROUP BY p.id, p.name, e.id, e.name, e.service_boundary
ORDER BY e.priority, e.created_at;
```

### 获取Story完整规格
```sql
SELECT 
  s.*,
  e.name as epic_name,
  p.name as project_name
FROM stories s
JOIN epics e ON s.epic_id = e.id
JOIN projects p ON s.project_id = p.id
WHERE s.id = $1 AND p.user_id = $2;
```

## 数据完整性约束

```sql
-- 确保Story属于正确的Epic和Project
ALTER TABLE stories 
ADD CONSTRAINT check_story_epic_project 
CHECK (
  epic_id IN (
    SELECT id FROM epics WHERE project_id = stories.project_id
  )
);

-- 确保优先级范围
ALTER TABLE epics ADD CONSTRAINT check_epic_priority CHECK (priority BETWEEN 1 AND 5);
ALTER TABLE stories ADD CONSTRAINT check_story_priority CHECK (priority BETWEEN 1 AND 5);

-- 确保状态值有效
ALTER TABLE epics ADD CONSTRAINT check_epic_status 
CHECK (status IN ('not_started', 'in_progress', 'completed'));

ALTER TABLE stories ADD CONSTRAINT check_story_status 
CHECK (status IN ('not_started', 'in_progress', 'completed'));
```

## 初始化脚本更新

需要在现有的 `init-database.sql` 中添加这些新表的创建语句，并关闭RLS：

```sql
-- 关闭新表的RLS
ALTER TABLE epics DISABLE ROW LEVEL SECURITY;
ALTER TABLE stories DISABLE ROW LEVEL SECURITY;
ALTER TABLE requirement_splitting_sessions DISABLE ROW LEVEL SECURITY;
```

这个设计支持完整的Epic/Story两层拆分架构，每个Story包含完整的技术实现规格，满足并行开发和接口契约的需求。